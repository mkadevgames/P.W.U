<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>PROBLEMS WITH UBER: RPG EDITION</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Press+Start+2P&display=swap');

        :root {
            --neon: #00ff9d;
            --blue: #00d9ff;
            --pink: #ff0055;
            --gold: #ffd700;
            --bg: #020202;
            --glass: rgba(10, 10, 10, 0.9);
        }

        * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; user-select: none; }
        
        body, html { 
            margin: 0; padding: 0; width: 100%; height: 100%; 
            background: var(--bg); color: #fff;
            font-family: 'Orbitron', sans-serif; overflow: hidden;
        }

        #map { 
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 1;
            filter: invert(100%) hue-rotate(180deg) brightness(0.6) contrast(1.3);
        }

        .crt-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.1) 50%), linear-gradient(90deg, rgba(255, 0, 0, 0.02), rgba(0, 255, 0, 0.01), rgba(0, 0, 255, 0.02));
            z-index: 9999; background-size: 100% 3px, 3px 100%; pointer-events: none;
        }

        .hud {
            position: absolute; z-index: 1000; pointer-events: auto;
            background: var(--glass); border: 2px solid var(--neon);
            backdrop-filter: blur(8px); padding: 12px; border-radius: 4px;
            box-shadow: 0 0 15px var(--neon);
        }

        #header {
            top: 20px; left: 20px; right: 20px; height: 80px;
            display: flex; justify-content: space-between; align-items: center;
        }

        .stat-group { display: flex; flex-direction: column; align-items: center; }
        .label { font-size: 10px; color: var(--blue); text-transform: uppercase; margin-bottom: 4px; font-family: 'Press Start 2P'; }
        .value { font-size: 20px; font-weight: bold; color: var(--gold); }

        #gps {
            top: 110px; left: 20px; width: 250px; font-size: 12px;
            border-color: var(--blue); color: var(--blue);
        }

        #controls {
            position: absolute; bottom: 30px; right: 30px;
            z-index: 1000; display: grid; grid-template-columns: repeat(3, 75px);
            grid-template-rows: repeat(3, 75px); gap: 15px;
        }

        .btn {
            width: 75px; height: 75px; background: var(--glass);
            border: 2px solid var(--neon); border-radius: 50%;
            display: flex; justify-content: center; align-items: center;
            color: var(--neon); font-size: 28px; cursor: pointer;
            transition: 0.1s; box-shadow: 0 0 10px var(--neon);
        }

        .btn:active { background: var(--neon); color: #000; transform: scale(0.9); }

        .btn-uber {
            position: absolute; bottom: 30px; left: 30px; z-index: 1000;
            width: 90px; height: 90px; background: var(--gold);
            border: 3px solid #000; border-radius: 50%; font-weight: bold;
            color: #000; font-size: 14px; cursor: pointer; box-shadow: 0 0 20px var(--gold);
        }

        .modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95); z-index: 10000;
            display: flex; justify-content: center; align-items: center;
        }

        .card {
            background: #111; border: 4px solid var(--neon);
            width: 90%; max-width: 400px; padding: 30px; text-align: center;
            position: relative; box-shadow: 0 0 40px var(--neon);
        }

        h1, h2 { font-family: 'Press Start 2P'; font-size: 14px; color: var(--neon); margin-bottom: 20px; }

        input {
            background: #000; border: 1px solid var(--blue);
            color: #fff; padding: 15px; width: 100%; margin-bottom: 20px;
            font-family: 'Orbitron'; text-align: center;
        }

        button.action-btn {
            background: var(--neon); color: #000; border: none;
            padding: 18px; width: 100%; font-weight: bold; font-size: 16px;
            cursor: pointer; font-family: 'Orbitron'; text-transform: uppercase;
        }

        #car-list { max-height: 300px; overflow-y: auto; margin-top: 15px; }
        .car-row {
            background: #1a1a1a; margin: 8px 0; padding: 12px;
            display: flex; justify-content: space-between; align-items: center;
            border-left: 4px solid var(--pink);
        }

        #battle-container { width: 100%; height: 40px; background: #333; margin: 20px 0; border: 2px solid #fff; }
        #battle-bar { height: 100%; width: 50%; background: var(--pink); transition: 0.05s; }

        #work-bar-container { width: 100%; height: 20px; background: #222; margin: 20px 0; border-radius: 10px; overflow: hidden; }
        #work-bar { height: 100%; width: 0%; background: var(--gold); }

        .player-dot { 
            width: 20px; height: 20px; background: var(--neon); 
            border: 3px solid #fff; border-radius: 50%; box-shadow: 0 0 15px var(--neon);
        }

        .car-marker { font-size: 30px; text-shadow: 0 0 10px #000; cursor: pointer; }
        .hidden { display: none !important; }
    </style>
</head>
<body>

<div class="crt-overlay"></div>
<div id="map"></div>

<div id="ui-main" class="hidden">
    <div id="header" class="hud">
        <div class="stat-group">
            <span class="label">Cr√©ditos</span>
            <span id="txt-money" class="value">R$ 0</span>
        </div>
        <div class="stat-group">
            <span class="label">Streak</span>
            <span id="txt-streak" class="value">üî• 0</span>
        </div>
        <div class="stat-group">
            <button onclick="manager.openGarage()" style="background:var(--pink); border:none; padding:8px; color:#fff; font-size:10px; cursor:pointer;">GARAGEM</button>
        </div>
    </div>

    <div id="gps" class="hud">üìç <span id="txt-gps">Sincronizando...</span></div>

    <button class="btn-uber" onclick="manager.requestJob()">FAZER<br>UBER</button>

    <div id="controls">
        <div style="grid-column: 2" class="btn" id="ctrl-up">‚Üë</div>
        <div style="grid-column: 1" class="btn" id="ctrl-left">‚Üê</div>
        <div style="grid-column: 2" class="btn" id="ctrl-down">‚Üì</div>
        <div style="grid-column: 3" class="btn" id="ctrl-right">‚Üí</div>
    </div>
</div>

<div id="overlay" class="modal">
    <div id="screen-start" class="card">
        <h1>PROBLEMS WITH UBER</h1>
        <p style="font-size: 10px; color: var(--blue); margin-bottom: 20px;">SYSTEM READY</p>
        <input type="text" id="player-name" placeholder="NOME DO PILOTO">
        <input type="text" id="player-city" placeholder="CIDADE BASE">
        <button class="action-btn" onclick="core.start()">INICIALIZAR</button>
    </div>

    <div id="screen-battle" class="card hidden">
        <h1 style="color:var(--pink)">HIJACKING...</h1>
        <p id="battle-target"></p>
        <div id="battle-container"><div id="battle-bar"></div></div>
        <button class="action-btn" style="height: 100px;" onmousedown="core.tap()" ontouchstart="core.tap()">CLICAR R√ÅPIDO!</button>
    </div>

    <div id="screen-garage" class="card hidden">
        <h2>MINHA BOLSA</h2>
        <div id="car-list"></div>
        <button class="action-btn" onclick="manager.closeModal()" style="margin-top:20px; background:#444; color:#fff;">VOLTAR</button>
    </div>

    <div id="screen-job" class="card hidden">
        <h1 style="color:var(--gold)">NOVA CORRIDA</h1>
        <p id="job-info"></p>
        <button class="action-btn" onclick="manager.startJob()">ACEITAR</button>
        <button class="action-btn" onclick="manager.closeModal()" style="background:#444; color:#fff; margin-top:10px;">RECUSAR</button>
    </div>

    <div id="screen-working" class="card hidden">
        <h1>EM ROTA...</h1>
        <div id="work-bar-container"><div id="work-bar"></div></div>
        <p id="work-timer" style="font-size: 30px;">0s</p>
    </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
const CAR_DATA = [
    {n: "Fusca de TI", r: 1}, {n: "Corsa Rebaixado", r: 1}, {n: "Uno com Escada", r: 1.5},
    {n: "Gol Quadrado", r: 1}, {n: "Kombi de Churros", r: 2}, {n: "Civic de Cria", r: 2.2},
    {n: "Corolla de Vov√¥", r: 2}, {n: "Tesla Fake", r: 3}, {n: "Marea Turbo", r: 3.5},
    {n: "Opala 6cc", r: 3.2}, {n: "Skyline GTR", r: 4.5}, {n: "Supra MK4", r: 4.8},
    {n: "Batmovel", r: 6}, {n: "DeLorean", r: 5.5}, {n: "Millenium Falcon", r: 10},
    {n: "Bicicleta com Motor", r: 0.8}, {n: "Skate El√©trico", r: 0.5}, {n: "Ferrari do Egito", r: 7},
    {n: "Lambo Neon", r: 7.5}, {n: "Fusca Herbie", r: 3}
];

for(let i=0; i<30; i++) { CAR_DATA.push({n: `Carro Custom #${i}`, r: (Math.random()*5+1).toFixed(1)}); }

const audio = {
    ctx: null,
    init() { this.ctx = new (window.AudioContext || window.webkitAudioContext)(); },
    play(freq, type, dur) {
        if(!this.ctx) return;
        let osc = this.ctx.createOscillator();
        let gain = this.ctx.createGain();
        osc.type = type;
        osc.frequency.setValueAtTime(freq, this.ctx.currentTime);
        gain.gain.setValueAtTime(0.1, this.ctx.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.01, this.ctx.currentTime + dur);
        osc.connect(gain); gain.connect(this.ctx.destination);
        osc.start(); osc.stop(this.ctx.currentTime + dur);
    },
    click() { this.play(400, 'square', 0.1); },
    win() { this.play(800, 'sine', 0.3); this.play(1200, 'sine', 0.5); },
    fail() { this.play(150, 'sawtooth', 0.5); }
};

const core = {
    state: {
        name: '', money: 0, garage: [], currentCar: null,
        streak: 0, lastLogin: 0, pos: [-23.55, -46.63],
        lockedUntil: 0, reward: 0
    },
    map: null, playerMarker: null, keys: {}, battle: null,

    start() {
        audio.init();
        this.state.name = document.getElementById('player-name').value || 'User';
        let city = document.getElementById('player-city').value;
        
        let saved = localStorage.getItem('pwu_rpg_save');
        if(saved) {
            let data = JSON.parse(saved);
            Object.assign(this.state, data);
        }

        this.checkStreak();

        if(city) {
            fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${city}`)
                .then(r => r.json()).then(d => {
                    if(d.length) this.state.pos = [parseFloat(d[0].lat), parseFloat(d[0].lon)];
                    this.initMap();
                }).catch(() => this.initMap());
        } else this.initMap();
    },

    initMap() {
        document.getElementById('overlay').classList.add('hidden');
        document.getElementById('ui-main').classList.remove('hidden');

        this.map = L.map('map', { 
            center: this.state.pos, zoom: 18, 
            zoomControl: false, dragging: false, touchZoom: false 
        });

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(this.map);
        this.playerMarker = L.marker(this.state.pos, {
            icon: L.divIcon({className: 'player-dot', iconSize:[20,20]})
        }).addTo(this.map);

        this.loop();
        setInterval(() => this.spawnCar(), 8000);
        setInterval(() => this.updateGPS(), 10000);
        this.bind();
        this.updateHUD();
        if(this.state.lockedUntil > Date.now()) manager.resumeWork();
    },

    checkStreak() {
        let now = Date.now();
        let day = 86400000;
        if(this.state.lastLogin > 0) {
            let diff = now - this.state.lastLogin;
            if(diff < day * 2 && diff > day) this.state.streak++;
            else if(diff > day * 2) this.state.streak = 0;
        } else this.state.streak = 1;
        this.state.lastLogin = now;
        this.save();
    },

    bind() {
        window.onkeydown = e => this.keys[e.key.toLowerCase()] = true;
        window.onkeyup = e => this.keys[e.key.toLowerCase()] = false;
        const setup = (id, key) => {
            let el = document.getElementById(id);
            el.onmousedown = el.ontouchstart = e => { e.preventDefault(); this.keys[key] = true; };
            el.onmouseup = el.ontouchend = () => this.keys[key] = false;
        };
        setup('ctrl-up', 'w'); setup('ctrl-down', 's'); setup('ctrl-left', 'a'); setup('ctrl-right', 'd');
    },

    loop() {
        if(this.state.lockedUntil < Date.now() && !this.battle) {
            let speed = 0.00006;
            if(this.state.currentCar) speed += (this.state.currentCar.r * 0.00002);

            if(this.keys['w'] || this.keys['arrowup']) this.state.pos[0] += speed;
            if(this.keys['s'] || this.keys['arrowdown']) this.state.pos[0] -= speed;
            if(this.keys['a'] || this.keys['arrowleft']) this.state.pos[1] -= speed;
            if(this.keys['d'] || this.keys['arrowright']) this.state.pos[1] += speed;

            this.playerMarker.setLatLng(this.state.pos);
            this.map.panTo(this.state.pos, {animate: false});
        }
        requestAnimationFrame(() => this.loop());
    },

    spawnCar() {
        let lat = this.state.pos[0] + (Math.random()-0.5) * 0.008;
        let lng = this.state.pos[1] + (Math.random()-0.5) * 0.008;
        let car = CAR_DATA[Math.floor(Math.random()*CAR_DATA.length)];
        
        let m = L.marker([lat, lng], {
            icon: L.divIcon({className: 'car-marker', html: 'üöó'})
        }).addTo(this.map);

        m.on('click', () => {
            if(this.map.distance(this.state.pos, m.getLatLng()) < 70) this.startBattle(car, m);
        });
        setTimeout(() => this.map.removeLayer(m), 20000);
    },

    startBattle(car, marker) {
        audio.click();
        this.battle = { car, marker, progress: 50 };
        document.getElementById('overlay').classList.remove('hidden');
        document.getElementById('screen-battle').classList.remove('hidden');
        document.getElementById('battle-target').innerText = `ALVO: ${car.n} (Raridade: ${car.r})`;
        
        this.battleTimer = setInterval(() => {
            this.battle.progress -= (0.4 + (car.r * 0.15));
            document.getElementById('battle-bar').style.width = this.battle.progress + '%';
            if(this.battle.progress <= 0) this.endBattle(false);
        }, 50);
    },

    tap() {
        if(!this.battle) return;
        audio.click();
        this.battle.progress += 4;
        if(this.battle.progress >= 100) this.endBattle(true);
    },

    endBattle(win) {
        clearInterval(this.battleTimer);
        if(win) {
            audio.win();
            this.state.garage.push(this.battle.car);
            this.map.removeLayer(this.battle.marker);
        } else audio.fail();
        this.battle = null;
        manager.closeModal();
        this.save();
    },

    updateGPS() {
        fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${this.state.pos[0]}&lon=${this.state.pos[1]}`)
            .then(r => r.json()).then(d => {
                document.getElementById('txt-gps').innerText = d.address.road || d.address.suburb || "√Årea Deserta";
            }).catch(() => {});
    },

    updateHUD() {
        document.getElementById('txt-money').innerText = `R$ ${this.state.money}`;
        document.getElementById('txt-streak').innerText = `üî• ${this.state.streak}`;
    },

    save() {
        localStorage.setItem('pwu_rpg_save', JSON.stringify(this.state));
    }
};

const manager = {
    openGarage() {
        document.getElementById('overlay').classList.remove('hidden');
        document.getElementById('screen-garage').classList.remove('hidden');
        let list = document.getElementById('car-list');
        list.innerHTML = '';
        core.state.garage.forEach((c, i) => {
            list.innerHTML += `
                <div class="car-row">
                    <span>${c.n}</span>
                    <button onclick="manager.equip(${i})" style="background:var(--blue); border:none; padding:5px 10px; cursor:pointer;">EQUIPAR</button>
                </div>
            `;
        });
    },

    equip(i) {
        core.state.currentCar = core.state.garage[i];
        audio.win();
        this.closeModal();
        core.save();
    },

    requestJob() {
        if(!core.state.currentCar) return alert("EQUIPE UM CARRO NA GARAGEM PRIMEIRO!");
        let dist = (Math.random() * 8 + 2).toFixed(1);
        let reward = Math.floor(dist * 50 * (core.state.streak + 1));
        document.getElementById('job-info').innerText = `CLIENTE A ${dist}KM.\nRECOMPENSA: R$ ${reward}`;
        window.pending = { reward, time: dist * 1000 };
        document.getElementById('overlay').classList.remove('hidden');
        document.getElementById('screen-job').classList.remove('hidden');
    },

    startJob() {
        core.state.lockedUntil = Date.now() + window.pending.time;
        core.state.reward = window.pending.reward;
        core.save();
        this.resumeWork();
    },

    resumeWork() {
        document.getElementById('screen-job').classList.add('hidden');
        document.getElementById('screen-working').classList.remove('hidden');
        document.getElementById('overlay').classList.remove('hidden');
        
        let start = Date.now();
        let total = core.state.lockedUntil - start;

        let t = setInterval(() => {
            let remain = core.state.lockedUntil - Date.now();
            if(remain <= 0) {
                clearInterval(t);
                core.state.money += core.state.reward;
                core.state.lockedUntil = 0;
                audio.win();
                core.updateHUD();
                core.save();
                this.closeModal();
            } else {
                let perc = 100 - (remain / total * 100);
                document.getElementById('work-bar').style.width = perc + '%';
                document.getElementById('work-timer').innerText = (remain/1000).toFixed(1) + 's';
            }
        }, 100);
    },

    closeModal() {
        document.getElementById('overlay').classList.add('hidden');
        document.querySelectorAll('.card').forEach(c => c.classList.add('hidden'));
    }
};
</script>
</body>
</html>
